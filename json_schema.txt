{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "LetsApp Database Schema",
  "description": "JSON Schema for the LetsApp application database models",
  "definitions": {
    "objectId": {
      "type": "string",
      "description": "MongoDB ObjectId represented as a string"
    },
    "timestamp": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 date-time format"
    },
    "User": {
      "type": "object",
      "required": ["_id", "username", "email", "password", "created_at", "updated_at", "last_seen", "is_active"],
      "properties": {
        "_id": { "$ref": "#/definitions/objectId" },
        "username": { "type": "string" },
        "email": { "type": "string", "format": "email" },
        "password": { "type": "string", "description": "Bcrypt hashed password" },
        "full_name": { "type": ["string", "null"] },
        "profile_picture": { "type": ["string", "null"], "description": "Reference to Media document ID" },
        "created_at": { "$ref": "#/definitions/timestamp" },
        "updated_at": { "$ref": "#/definitions/timestamp" },
        "last_seen": { "$ref": "#/definitions/timestamp" },
        "is_active": { "type": "boolean" },
        "bio": { "type": "string" },
        "settings": {
          "type": "object",
          "properties": {
            "notifications_enabled": { "type": "boolean" },
            "read_receipts_enabled": { "type": "boolean" },
            "typing_indicators_enabled": { "type": "boolean" }
          }
        },
        "password_history": {
          "type": "array",
          "items": { "type": "string", "description": "Previous bcrypt hashed passwords" },
          "maxItems": 5,
          "description": "Last 5 password hashes for preventing password reuse"
        },
        "last_password_change": { "$ref": "#/definitions/timestamp" }
      }
    },
    "Message": {
      "type": "object",
      "required": ["_id", "sender_id", "recipient_id", "content", "created_at", "updated_at", "status", "is_deleted"],
      "properties": {
        "_id": { "$ref": "#/definitions/objectId" },
        "sender_id": { "$ref": "#/definitions/objectId" },
        "recipient_id": { "$ref": "#/definitions/objectId" },
        "content": { "type": "string" },
        "message_type": {
          "type": "string",
          "enum": ["text", "image", "audio", "video", "document"]
        },
        "attachment": {
          "type": ["object", "null"],
          "properties": {
            "media_id": { "$ref": "#/definitions/objectId" }
          }
        },
        "created_at": { "$ref": "#/definitions/timestamp" },
        "updated_at": { "$ref": "#/definitions/timestamp" },
        "status": {
          "type": "string",
          "enum": ["sent", "delivered", "read"]
        },
        "is_deleted": { "type": "boolean" }
      }
    },
    "GroupMessage": {
      "type": "object",
      "required": ["_id", "group_id", "sender_id", "content", "created_at", "is_deleted"],
      "properties": {
        "_id": { "$ref": "#/definitions/objectId" },
        "group_id": { "$ref": "#/definitions/objectId" },
        "sender_id": { "$ref": "#/definitions/objectId" },
        "content": { "type": "string" },
        "message_type": {
          "type": "string",
          "enum": ["text", "image", "audio", "video", "document"]
        },
        "attachment": {
          "type": ["object", "null"],
          "properties": {
            "media_id": { "$ref": "#/definitions/objectId" }
          }
        },
        "created_at": { "$ref": "#/definitions/timestamp" },
        "updated_at": { "$ref": "#/definitions/timestamp" },
        "read_by": {
          "type": "array",
          "items": { "$ref": "#/definitions/objectId" }
        },
        "is_deleted": { "type": "boolean" }
      }
    },
    "Group": {
      "type": "object",
      "required": ["_id", "name", "creator_id", "members", "admins", "created_at", "updated_at", "is_active"],
      "properties": {
        "_id": { "$ref": "#/definitions/objectId" },
        "name": { "type": "string" },
        "description": { "type": ["string", "null"] },
        "icon": { "type": ["string", "null"] },
        "creator_id": { "$ref": "#/definitions/objectId" },
        "members": {
          "type": "array",
          "items": { "$ref": "#/definitions/objectId" }
        },
        "admins": {
          "type": "array",
          "items": { "$ref": "#/definitions/objectId" }
        },
        "created_at": { "$ref": "#/definitions/timestamp" },
        "updated_at": { "$ref": "#/definitions/timestamp" },
        "is_active": { "type": "boolean" }
      }
    },
    "Contact": {
      "type": "object",
      "required": ["_id", "user_id", "contact_id", "status", "created_at", "updated_at"],
      "properties": {
        "_id": { "$ref": "#/definitions/objectId" },
        "user_id": { "$ref": "#/definitions/objectId" },
        "contact_id": { "$ref": "#/definitions/objectId" },
        "status": {
          "type": "string",
          "enum": ["pending", "accepted", "blocked"]
        },
        "created_at": { "$ref": "#/definitions/timestamp" },
        "updated_at": { "$ref": "#/definitions/timestamp" },
        "notes": { "type": "string" },
        "is_favorite": { "type": "boolean" }
      }
    },
    "Call": {
      "type": "object",
      "required": ["_id", "caller_id", "call_type", "started_at", "status"],
      "properties": {
        "_id": { "$ref": "#/definitions/objectId" },
        "caller_id": { "$ref": "#/definitions/objectId" },
        "recipient_id": { "$ref": "#/definitions/objectId" },
        "group_id": { "$ref": "#/definitions/objectId" },
        "call_type": {
          "type": "string",
          "enum": ["voice", "video"]
        },
        "started_at": { "$ref": "#/definitions/timestamp" },
        "ended_at": { "$ref": "#/definitions/timestamp" },
        "status": {
          "type": "string",
          "enum": ["initiated", "ringing", "ongoing", "ended", "missed", "rejected"]
        },
        "duration": { "type": "number" },
        "participants": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "user_id": { "$ref": "#/definitions/objectId" },
              "joined_at": { "$ref": "#/definitions/timestamp" },
              "left_at": { "$ref": "#/definitions/timestamp" }
            }
          }
        },
        "metadata": { "type": "object" }
      }
    },
    "Media": {
      "type": "object",
      "required": ["_id", "filename", "original_filename", "file_size", "media_type", "mime_type", "uploader_id", "created_at", "view_count", "is_deleted"],
      "properties": {
        "_id": { "$ref": "#/definitions/objectId" },
        "filename": { "type": "string", "description": "Secure randomly generated filename" },
        "original_filename": { "type": "string" },
        "file_size": { "type": "number" },
        "media_type": {
          "type": "string",
          "enum": ["image", "video", "audio"]
        },
        "mime_type": { "type": "string" },
        "uploader_id": { "$ref": "#/definitions/objectId" },
        "message_id": { "$ref": "#/definitions/objectId" },
        "group_message_id": { "$ref": "#/definitions/objectId" },
        "duration": { "type": "number" },
        "thumbnail": { 
          "type": "string",
          "description": "Filename of the thumbnail for profile pictures and images"
        },
        "width": { "type": "number" },
        "height": { "type": "number" },
        "created_at": { "$ref": "#/definitions/timestamp" },
        "view_count": { "type": "number" },
        "is_deleted": { "type": "boolean" },
        "optimized": { "type": "boolean", "description": "Whether the image has been optimized" }
      }
    },
    "Presence": {
      "type": "object",
      "required": ["_id", "user_id", "status", "last_active"],
      "properties": {
        "_id": { "$ref": "#/definitions/objectId" },
        "user_id": { "$ref": "#/definitions/objectId" },
        "status": {
          "type": "string",
          "enum": ["online", "away", "busy", "offline"]
        },
        "last_active": { "$ref": "#/definitions/timestamp" },
        "custom_status": { "type": "string" },
        "device_info": {
          "type": "object",
          "properties": {
            "device_type": { "type": "string" },
            "app_version": { "type": "string" },
            "platform": { "type": "string" }
          }
        }
      }
    },
    "File": {
      "type": "object",
      "required": ["_id", "filename", "original_filename", "file_size", "mime_type", "uploader_id", "created_at", "is_deleted"],
      "properties": {
        "_id": { "$ref": "#/definitions/objectId" },
        "filename": { "type": "string" },
        "original_filename": { "type": "string" },
        "file_size": { "type": "number" },
        "mime_type": { "type": "string" },
        "uploader_id": { "$ref": "#/definitions/objectId" },
        "message_id": { "$ref": "#/definitions/objectId" },
        "group_message_id": { "$ref": "#/definitions/objectId" },
        "created_at": { "$ref": "#/definitions/timestamp" },
        "download_count": { "type": "number" },
        "is_deleted": { "type": "boolean" }
      }
    },
    "PasswordReset": {
      "type": "object",
      "required": ["_id", "user_id", "token", "expiry", "created_at"],
      "properties": {
        "_id": { "$ref": "#/definitions/objectId" },
        "user_id": { "$ref": "#/definitions/objectId" },
        "token": { "type": "string" },
        "expiry": { "$ref": "#/definitions/timestamp" },
        "created_at": { "$ref": "#/definitions/timestamp" },
        "used": { "type": "boolean", "default": false }
      }
    }
  },
  "type": "object",
  "properties": {
    "users": {
      "type": "array",
      "items": { "$ref": "#/definitions/User" }
    },
    "messages": {
      "type": "array",
      "items": { "$ref": "#/definitions/Message" }
    },
    "group_messages": {
      "type": "array",
      "items": { "$ref": "#/definitions/GroupMessage" }
    },
    "groups": {
      "type": "array",
      "items": { "$ref": "#/definitions/Group" }
    },
    "contacts": {
      "type": "array",
      "items": { "$ref": "#/definitions/Contact" }
    },
    "calls": {
      "type": "array",
      "items": { "$ref": "#/definitions/Call" }
    },
    "media": {
      "type": "array",
      "items": { "$ref": "#/definitions/Media" }
    },
    "presence": {
      "type": "array",
      "items": { "$ref": "#/definitions/Presence" }
    },
    "files": {
      "type": "array",
      "items": { "$ref": "#/definitions/File" }
    },
    "password_reset_tokens": {
      "type": "array",
      "items": { "$ref": "#/definitions/PasswordReset" }
    }
  }
}